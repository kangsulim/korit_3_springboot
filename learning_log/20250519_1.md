# ë‹¤ë¥¸ ìš”ì²­ë“¤ ë³´í˜¸í•˜ê¸°



---

## ë°œê¸‰ëœ JWT í™•ì¸ ê³¼ì •

1.  í•„í„° í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ëª¨ë“  ë‹¤ë¥¸ ìˆ˜ì‹  ìš”ì²­ì„ ì¸ì¦ì²˜ë¦¬. ë£¨íŠ¸ íŒ¨í‚¤ì§€ì— AuthenticationFilter í´ë˜ìŠ¤ ìƒì„±.
    í´ë˜ìŠ¤ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ OncePerRequestFilter ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¥í•˜ì—¬ ì¸ì¦ì„ êµ¬í˜„í•˜ëŠ” doFilterInternal
    ë©”ì„œë“œ ì œê³µ. ìš”ì²­ì—ì„œ í† í°ì„ í™•ì¸í•˜ê¸° ìœ„í•´ í•„í„° í´ë˜ìŠ¤ì—ì„œ JwtService ì¸ìŠ¤í„´ìŠ¤ ì£¼ì…. SecurityContextHolderë¥¼
    í†µí•˜ì—¬ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì„¸ë¶€ ì •ë³´ ì €ì¥.

    ì½”ë“œ ì‘ì„±

    ```java
    package com.example.cardatabase;
    
    import com.example.cardatabase.service.JwtService;
    import jakarta.servlet.FilterChain;
    import jakarta.servlet.ServletException;
    import jakarta.servlet.http.HttpServletRequest;
    import jakarta.servlet.http.HttpServletResponse;
    import org.springframework.http.HttpHeaders;
    import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
    import org.springframework.security.core.Authentication;
    import org.springframework.security.core.context.SecurityContextHolder;
    import org.springframework.stereotype.Component;
    import org.springframework.web.filter.OncePerRequestFilter;
    
    import java.io.IOException;
    import java.util.Collections;
    
    @Component
    public class AuthenticationFilter extends OncePerRequestFilter {
    private final JwtService jwtService;
    
        public AuthenticationFilter(JwtService jwtService) {
            this.jwtService = jwtService;
        }
    
        // default format (ì¤‘ìš”)
        @Override
        protected void doFilterInternal(HttpServletRequest request,
                                        HttpServletResponse response,
                                        FilterChain filterChain)
                throws ServletException, IOException {
            // í† í° ê²€ì¦ ë° ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸° #1
            String jws = request.getHeader(HttpHeaders.AUTHORIZATION);
            if (jws != null) {
                // í† í° ê²€ì¦ ë° ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸° #2
                String user = jwtService.getAuthUser(request);
                // ì¸ì¦
                Authentication authentication =
                        new UsernamePasswordAuthenticationToken(user, null, Collections.emptyList());
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
            filterChain.doFilter(request, response);
    
            
        }
    }

    ```

2.  ìŠ¤í”„ë§ ì‹œíë¦¬í‹° config ê´€ë ¨ í•„í„° í´ë˜ìŠ¤ ì¶”ê°€. SecurityConfig í´ë˜ìŠ¤ì— AuthenticationFilter ì£¼ì….

    ```java
    public class SecurityConfig {
    
        private final UserDetailsServiceImpl userDetailsService;
        // ì¶”ê°€ëœ ì£¼ì… ë¶€ë¶„
        private final AuthenticationFilter authenticationFilter;
    
        public SecurityConfig(UserDetailsServiceImpl userDetailsService, AuthenticationFilter authenticationFilter) {
            this.userDetailsService = userDetailsService;
            this.authenticationFilter = authenticationFilter;   // ìƒì„±ìì—ë„ ì¶”ê°€
        }
    // ...
    }
    ```

3.  AuthenticationFilter ì£¼ì…ì— ë”°ë¥¸ SecurityConfig í´ë˜ìŠ¤ì—ì„œ filterChain ë©”ì„œë“œ ìˆ˜ì •

    ```java
    package com.example.cardatabase;
    
    import com.example.cardatabase.service.UserDetailsServiceImpl;
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.http.HttpMethod;
    import org.springframework.security.authentication.AuthenticationManager;
    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
    import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.config.http.SessionCreationPolicy;
    import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
    import org.springframework.security.crypto.password.PasswordEncoder;
    import org.springframework.security.core.Authentication;
    import org.springframework.security.core.userdetails.User;
    import org.springframework.security.core.userdetails.UserDetails;
    import org.springframework.security.provisioning.InMemoryUserDetailsManager;
    import org.springframework.security.web.SecurityFilterChain;
    import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
    
    @Configuration
    @EnableWebSecurity
    public class SecurityConfig {
    
        private final UserDetailsServiceImpl userDetailsService;
        private final AuthenticationFilter authenticationFilter;
    
        public SecurityConfig(UserDetailsServiceImpl userDetailsService, AuthenticationFilter authenticationFilter) {
            this.userDetailsService = userDetailsService;
            this.authenticationFilter = authenticationFilter;
        }
    
        public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
            auth.userDetailsService(userDetailsService).passwordEncoder(new BCryptPasswordEncoder());
        }
    
        @Bean
        public PasswordEncoder passwordEncoder() {
            return new BCryptPasswordEncoder();
        }
    
        @Bean
        public AuthenticationManager authenticationManager(
                AuthenticationConfiguration authConfig) throws Exception {
            return authConfig.getAuthenticationManager();
        }
    
        // AuthenticationFilter(í† í° ê²€ì‚¬ ê¸°ëŠ¥) ìƒì„± ì´í›„
        @Bean
        public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
            http.csrf((csrf) -> csrf.disable())
                    .sessionManagement((sessionManagement)
                            -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                    .authorizeHttpRequests((authorizeRequests) -> authorizeRequests.requestMatchers(HttpMethod.POST, "/login")
                            .permitAll().anyRequest().authenticated())
                    .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class);
    
            return http.build();
        }
    
        // AuthenticationFilter ìƒì„± ì´ì „
    //    @Bean
    //    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    //        http.csrf((csrf) -> csrf.disable())
    //                .sessionManagement((sessionManagement)
    //                        -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
    //                .authorizeHttpRequests((authorizeHttpRequest) ->
    //                        authorizeHttpRequest.requestMatchers(HttpMethod.POST, "/login")
    //                                .permitAll().anyRequest().authenticated());
    //
    //        return http.build();
    //    }
    }
    ```
    
4.  ì „ì²´ workflow í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„,
    POST ë¡œê·¸ì¸ -> Authorization í—¤ë”ì— JWT ìˆ˜ë ¹
```json
{
  "username": "user",
  "password": "user"
}, {
  "username": "admin", 
  "password": "admin"
}
```

## ì˜ˆì™¸ ì²˜ë¦¬í•˜ê¸°

ì§€ê¸ˆ ìˆëŠ” ë¬¸ì œ
- ì˜ëª»ëœ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„ ì‹œ, 403 Forbiddenë§Œ ë³´ì„
- id / ë¹„ë°€ë²ˆí˜¸ ê°€ ë“¤ë ¸ìŠµë‹ˆë‹¤. ì™€ ê°™ì€ í˜•íƒœë¡œ í•  ì˜ˆì „

1.  ë£¨íŠ¸ íŒ¨í‚¤ì§€ì— AuthenticationEntryPointë¥¼ êµ¬í˜„í•˜ëŠ” AuthEntryPoint í´ë˜ìŠ¤ ìƒì„±.
    ì˜ˆì™¸ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ëŠ” commence ë©”ì„œë“œ êµ¬í˜„. ì‘ë‹µ ìƒíƒœë¥¼ 401 Unauthorizedë¡œ ì„¤ì •,
    ì‘ë‹µ ë¶€ë¶„ì— ì˜ˆì™¸ ë©”ì‹œì§€ ì‘ì„±

    ```java
    package com.example.cardatabase;
    
    import jakarta.servlet.ServletException;
    import jakarta.servlet.http.HttpServletRequest;
    import jakarta.servlet.http.HttpServletResponse;
    import org.springframework.http.MediaType;
    import org.springframework.security.core.AuthenticationException;
    import org.springframework.security.web.AuthenticationEntryPoint;
    import org.springframework.stereotype.Component;
    
    import java.io.IOException;
    import java.io.PrintWriter;
    
    @Component
    public class AuthEntryPoint implements AuthenticationEntryPoint {
        @Override
        public void commence(HttpServletRequest request,
                             HttpServletResponse response,
                             AuthenticationException authException)
                throws IOException, ServletException {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.setContentType(MediaType.APPLICATION_JSON_VALUE);
            PrintWriter writer = response.getWriter();
            writer.println("Error(ì˜¤ë¥˜) : " + authException.getMessage());
        }
    }
    ```

2.  ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ë¥¼ êµ¬ì„±í•´ì•¼ í•œë‹¤. AuthEntryPoint í´ë˜ìŠ¤ë¥¼ SecurityConfigì— ì£¼ì….

   - ìƒì„±ì ì£¼ì…ê¹Œì§€ ì™„ë£Œ!!


3.  filterChain() ìˆ˜ì • -> í•œ ì¤„ ì¶”ê°€

## CORS í•„í„° ì¶”ê°€

SecurityConfig í´ë˜ìŠ¤ì— CORS í•„í„° ì¶”ê°€

CORSë€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ êµì°¨ ì¶œì²˜ ì¬ìš”ì²­ì„ í—ˆìš©í• ì§€ ê±°ë¶€í• ì§€ ê²°ì •

CORS í••ëŸ¬ëŠ” ë‹¤ë¥¸ ì¶œì²˜ì—ì„œ ìš”ì²­ì„ ë³´ë‚´ëŠ” frontend ì—ì„œ í•„ìš”í•¨

CORS í•„í„°ëŠ” ìš”ì²­ì— ê°„ì„­í•˜ì—¬, êµì°¨ ì¶œì²˜ë¡œ ì‹ë³„ë˜ë©´ ìš”ì²­ì— ì ì ˆí•œ í—¤ë”ë¥¼ ì¶”ê°€í•¨

-> CorsConfigurationSource ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©

1.  SecurityConfig í´ë˜ìŠ¤ì— import, ë©”ì„œë“œ ì¶”ê°€í•˜ì—¬ CORS í•„í„° í™œì„±í™”
    ```java
    // í´ë˜ìŠ¤ ë‚´ì— ì „ì—­ CORS í•„í„° ì¶”ê°€
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowedOrigins(Arrays.asList("*"));
        config.setAllowedMethods(Arrays.asList("*"));
        config.setAllowedHeaders(Arrays.asList("*"));
        config.setAllowCredentials(false);
        config.applyPermitDefaultValues();
        
        source.registerCorsConfiguration("/**", config);
        return source;
    }
    ```
ì¶œì²˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜í•˜ë ¤ë©´ (ì˜ˆë¥¼ ë“¤ì–´ localhost:3000ì„ í—ˆìš©í•˜ë ¤ë©´)
```java
config.setAllowedOrigins(Arrays.asList("Http://localhost:3000"));
```

2.  filterChain()ì— ë‚´ìš© ì¶”ê°€

    ```java
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf((csrf) -> csrf.disable())
                .cors(Customizer.withDefaults())
                .sessionManagement((sessionManagement)
                        -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests((authorizeRequests) -> authorizeRequests.requestMatchers(HttpMethod.POST, "/login")
                        .permitAll().anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling((exceptionHandling) -> exceptionHandling.authenticationEntryPoint(exceptionHandler));
    
        return http.build();
    }
    ```
CORSì˜ ê²½ìš° í”„ë¡ íŠ¸ì—”ë“œì™€ì˜ í†µì‹  ìƒì—ì„œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì§€ê¸ˆì€ ê²€ì¦í•  ìˆ˜ ì—†ìŒ.

cors() ë©”ì„œë“œì˜ argument, Customizer.withDefaults

ë§¤ê°œë³€ìˆ˜ê°€ ë„ˆë¬´ ê¸¸ì–´ì„œ ì§§ê²Œ ì“°ê¸° ìœ„í•´ 
import static org.springframework.security.config.Customizer.withDefaults; ì¶”ê°€

`Customizer.withDefaults() -> withDefaults() ë¡œ ë°”ë€œ`

(ì•„ë¬´ëŸ° ì°¨ì´ ì—†ì–´ì„œ êµ³ì´ ì•ˆ í•´ë„ ë¨)


> ë°±ì—”ë“œ ë³´í˜¸ ê³¼ì • -ì™„-, protectionì— ì´ˆì ì„ ë§ì¶˜ ë§Œí¼ SecurityConfig í´ë˜ìŠ¤ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í–ˆë‹¤.

---

## âœ… ë³€ê²½ëœ `filterChain` ë©”ì„œë“œ êµ¬ì¡° ë¶„ì„

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http.csrf((csrf) -> csrf.disable())                       // 1. CSRF ë¹„í™œì„±í™”
        .cors(withDefaults())                                 // 2. CORS ì„¤ì • ì¶”ê°€
        .sessionManagement((sessionManagement) ->
            sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS)) // 3. ì„¸ì…˜ ì‚¬ìš© ì•ˆ í•¨
        .authorizeHttpRequests((authorizeRequests) ->
            authorizeRequests.requestMatchers(HttpMethod.POST, "/login")
                .permitAll()
                .anyRequest().authenticated())                // 4. ë¡œê·¸ì¸ ì™¸ì—ëŠ” ì¸ì¦ í•„ìš”
        .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class) // 5. JWT í•„í„° ì¶”ê°€
        .exceptionHandling((exceptionHandling) ->
            exceptionHandling.authenticationEntryPoint(exceptionHandler)); // 6. ì¸ì¦ ì˜ˆì™¸ ì²˜ë¦¬

    return http.build();
}
```

---

## ğŸ” ì£¼ìš” ë³€ê²½ì  ì„¤ëª…

### 1. `cors(withDefaults())` â€“ **CORS ì„¤ì •**

* **CORS(Cross-Origin Resource Sharing)**: ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œ ìš”ì²­í•  ë•Œ ë³´ì•ˆì„ ìœ„í•´ ì œì•½ì´ ê±¸ë¦¬ëŠ” í˜„ìƒ.
* ì´ ì¤„ì€ êµì°¨ ì¶œì²˜ ìš”ì²­ì„ í—ˆìš©í•©ë‹ˆë‹¤.
* ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œê°€ `http://localhost:3000`, ë°±ì—”ë“œëŠ” `http://localhost:8080`ì¼ ë•Œ ì´ ì„¤ì •ì´ ì—†ìœ¼ë©´ ìš”ì²­ ì°¨ë‹¨ë©ë‹ˆë‹¤.

---

### 2. `addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)`

* `authenticationFilter`: ë³´í†µ **JWT í† í°ì„ ê²€ì‚¬í•˜ëŠ” ì»¤ìŠ¤í…€ í•„í„°**ì…ë‹ˆë‹¤.
* `UsernamePasswordAuthenticationFilter` **ì´ì „ì— ì‹¤í–‰**ë˜ë„ë¡ ì„¤ì •í•´, ìš”ì²­ì—ì„œ í† í°ì„ êº¼ë‚´ ê²€ì¦í•©ë‹ˆë‹¤.
* ì—­í• :

    * ìš”ì²­ í—¤ë”ì—ì„œ JWT í† í°ì„ ì¶”ì¶œ
    * ìœ íš¨í•˜ë©´ `SecurityContext`ì— ì¸ì¦ ì •ë³´ ì„¤ì •

ğŸ”§ ì´ í•„í„°ëŠ” ê°œë°œìê°€ ì§ì ‘ ë§Œë“  í´ë˜ìŠ¤ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:

```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    ...
}
```

---

### 3. `exceptionHandling().authenticationEntryPoint(exceptionHandler)`

* `exceptionHandler`: ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬í•˜ëŠ” **ì»¤ìŠ¤í…€ ì˜ˆì™¸ í•¸ë“¤ëŸ¬**ì…ë‹ˆë‹¤.
* ì˜ˆ: JWTê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°, ìë™ìœ¼ë¡œ 401 Unauthorized ì‘ë‹µì„ ë°˜í™˜

```java
public class AuthEntryPoint implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response,
                         AuthenticationException authException) throws IOException {
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Unauthorized");
    }
}
```

---

## âœ… ì •ë¦¬: ì–´ë–¤ ê¸°ëŠ¥ì´ ì¶”ê°€ëë‚˜?

| ì¶”ê°€ëœ ê¸°ëŠ¥           | ì„¤ëª…                          |
| ---------------- | --------------------------- |
| **CORS ì„¤ì •**      | í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œê°€ ë‹¤ë¥¸ ë„ë©”ì¸ì¼ ë•Œ ìš”ì²­ í—ˆìš© |
| **JWT ì¸ì¦ í•„í„° ì¶”ê°€** | ìš”ì²­ì—ì„œ í† í°ì„ êº¼ë‚´ ì¸ì¦ì„ ìˆ˜í–‰ (ì„¸ì…˜ ì—†ì´)  |
| **ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ë“±ë¡**    | ì¸ì¦ ì‹¤íŒ¨ ì‹œ 401 ì—ëŸ¬ ì²˜ë¦¬ ë‹´ë‹¹        |

---

## ğŸ” ì „ì²´ êµ¬ì¡° ìš”ì•½

ì´ ë³´ì•ˆ ì„¤ì •ì€ **JWT ê¸°ë°˜ ì¸ì¦ ì‹œìŠ¤í…œì„ ìœ„í•œ ì „í˜•ì ì¸ ë³´ì•ˆ êµ¬ì„±**ì…ë‹ˆë‹¤:

* `POST /login`: ë¡œê·¸ì¸ ì‹œ í† í° ë°œê¸‰
* ë‹¤ë¥¸ ìš”ì²­: í—¤ë”ì— í† í° í¬í•¨ â†’ `AuthenticationFilter`ê°€ ê²€ì¦ â†’ í†µê³¼ ì‹œ ì»¨íŠ¸ë¡¤ëŸ¬ ì ‘ê·¼ í—ˆìš©
* ì¸ì¦ ì‹¤íŒ¨: `AuthEntryPoint`ê°€ 401 ì‘ë‹µ













